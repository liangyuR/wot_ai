<!-- 84e07709-3efc-46b7-adbe-a17131b8f1ba 75e64ac8-5730-44a2-9c0a-5006a7a4fd22 -->
# 集成 UI 控制到 main.py

## 目标

将 UI 控制模块集成到 `main.py` 中，添加命令行参数控制是否先执行 UI 流程（车库→战斗），然后自动启动导航 AI。

## 当前代码状态

- `UIFlow` 类已实现，但 `_LaunchNavigationAI()` 方法只是占位
- `main.py` 目前没有命令行参数处理
- `NavigationMain` 类有 `Initialize()` 和 `Run()` 方法

## 实现步骤

### 1. 修改 `UIFlow._LaunchNavigationAI()` 方法

**文件：** `wot_ai/game_modules/ui_control/ui_flow.py`

- 修改方法签名，接收 `NavigationMain` 实例作为参数
- 在方法中调用 `nav_main.Run()` 启动导航 AI
- 添加错误处理和日志记录

**修改内容：**

```python
def _LaunchNavigationAI(self, nav_main: NavigationMain) -> None:
    """启动导航 AI"""
    logger.info("启动导航 AI...")
    try:
        nav_main.Run()
    except Exception as e:
        logger.error(f"导航 AI 启动失败: {e}")
        raise
```

### 2. 修改 `UIFlow.StartBattle()` 方法

**文件：** `wot_ai/game_modules/ui_control/ui_flow.py`

- 修改方法签名，接收 `NavigationMain` 实例作为参数
- 将 `nav_main` 传递给 `_LaunchNavigationAI()`

**修改内容：**

```python
def StartBattle(self, nav_main: NavigationMain) -> bool:
    # ... 现有代码 ...
    # Step 5: 启动导航 AI
    self._LaunchNavigationAI(nav_main)
    # ... 现有代码 ...
```

### 3. 在 `main.py` 中添加命令行参数支持

**文件：** `wot_ai/game_modules/main.py`

- 导入 `argparse` 模块
- 导入 `UIFlow` 类
- 在 `main()` 函数中添加参数解析
- 添加 `--ui-flow` 参数（布尔标志），控制是否先执行 UI 流程

**添加内容：**

```python
import argparse
from wot_ai.game_modules.ui_control import UIFlow

def main():
    parser = argparse.ArgumentParser(description="WOT AI 导航系统")
    parser.add_argument(
        '--ui-flow',
        action='store_true',
        help='先执行 UI 流程（车库→战斗），然后启动导航 AI'
    )
    args = parser.parse_args()
    
    # ... 现有配置代码 ...
    
    # 如果启用 UI 流程，先执行 UI 流程
    if args.ui_flow:
        logger.info("启用 UI 流程模式")
        ui_flow = UIFlow(
            click_delay=0.3,
            move_duration=0.2,
            garage_timeout=30.0,
            countdown_timeout=20.0
        )
        
        # 先初始化 NavigationMain（但不运行）
        nav_main = NavigationMain(config)
        if not nav_main.Initialize():
            logger.error("初始化失败，退出")
            return 1
        
        # 执行 UI 流程（会自动启动导航 AI）
        if not ui_flow.StartBattle(nav_main):
            logger.error("UI 流程执行失败")
            return 1
    else:
        # 直接启动导航 AI（原有逻辑）
        nav_main = NavigationMain(config)
        if not nav_main.Initialize():
            logger.error("初始化失败，退出")
            return 1
        
        try:
            nav_main.Run()
        except Exception as e:
            logger.error(f"运行错误: {e}")
            import traceback
            traceback.print_exc()
            return 1
        finally:
            nav_main.Stop()
    
    return 0
```

### 4. 处理循环依赖问题

**注意：** `UIFlow` 需要导入 `NavigationMain`，但 `NavigationMain` 在 `main.py` 中定义。

**解决方案：**

- 在 `ui_flow.py` 中使用 `TYPE_CHECKING` 和字符串类型注解，避免循环导入
- 或者将 `NavigationMain` 的类型注解改为字符串 `"NavigationMain"`

**修改内容：**

```python
from typing import TYPE_CHECKING

if TYPE_CHECKING:
    from wot_ai.game_modules.main import NavigationMain
```

## 使用方式

**直接启动导航 AI（原有方式）：**

```bash
python -m wot_ai.game_modules.main
```

**先执行 UI 流程，然后启动导航 AI：**

```bash
python -m wot_ai.game_modules.main --ui-flow
```

## 文件修改清单

1. `wot_ai/game_modules/ui_control/ui_flow.py` - 修改 `StartBattle()` 和 `_LaunchNavigationAI()` 方法
2. `wot_ai/game_modules/main.py` - 添加命令行参数解析和 UI 流程集成逻辑

### To-dos

- [ ] 创建路径简化模块：实现方向一致性判断简化路径
- [ ] 创建Catmull-Rom实现：实现centripetal Catmull-Rom插值（α=0.5）
- [ ] 实现曲率检查：计算heading和curvature，检测急弯并重新插值
- [ ] 创建主入口函数：在path_smoothing.py中添加smooth_path函数
- [ ] 集成到路径规划流程：在PlanPath中可选使用新的平滑方法